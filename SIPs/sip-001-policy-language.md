# SOPCOS IMPROVEMENT PROPOSAL (SIP-001)

| Metadata | Value |
| :--- | :--- |
| **SIP** | 001 |
| **Title** | Sopcos Policy Language (SPL) Definition |
| **Status** | LIVING STANDARD (REVISED) |
| **Type** | Standards Track (Core) |
| **Author** | Maestro, Nexus (Rev. by Legal Counsel) |
| **Created** | 2025-12-22 |
| **Last Revised** | 2026-01-05 |
| **Layer** | Authoring / Parsing |
| **Requires** | SIP-008, SIP-010 |
| **Obsoletes** | SIP-001 (Draft v1) Conflict Resolution Logic |

## 1. Abstract
Sopcos Policy Language (SPL) is a JSON-based, deterministic specification designed to validate intents within the Sopcos Ecosystem. Unlike traditional smart contracts, SPL is not a scripting language; it is a **configuration of law**. It defines *whether* an action is permissible without instructing the device *how* to perform it.

> **Revision Note:** This document defines the **syntax and serialization** of the language. 
> * For Authority Hierarchy, please refer to **SIP-008**.
> * For Conflict Resolution Logic, please refer to **SIP-010**.

## 2. Motivation
In industrial IoT environments, "Code is Law" (Smart Contracts) introduces unacceptable risks. Sopcos introduces "Policy as Data":
* **No Scripting:** Eliminates halting problems and security exploits.
* **Deterministic:** The same input always results in the same verdict.
* **Auditable:** Every decision is traceable to a specific policy hash.

## 3. Specification

### 3.1. Philosophy & Motto
**"SPL does not instruct devices how to act. SPL defines whether an intent is permissible."**

* **Verdict, Not Command:** SPL returns `ALLOW`, `DENY`, or `WARN`. It never returns low-level commands like `GPIO_HIGH`.
* **Fail-Closed:** In the absence of a matching policy, the default behavior MUST be `DENY`.

### 3.2. Identity & Authority
A policy is a data object. Its validity is not intrinsic but derived from the **Cryptographic Envelope** defined in SIP-009 and the **Authority Graph** defined in SIP-008.

* **Separation of Concerns:** The JSON payload defines the *Logic*. The Envelope signature defines the *Authority*.

### 3.3. Normative Domains & Hierarchy (Revised)
*(Updated to comply with SIP-008)*

Implementations **MUST NOT** rely on arbitrary metadata integers or legacy `0x03` tags for authority precedence. Instead, implementations **MUST** map the signer's Identity (DID) to the Normative Authority Graph defined in SIP-008:

* **LVL 0:** Emergency
* **LVL 1:** Regulatory
* **LVL 2:** Site/Org
* **LVL 3:** Optimization
* **LVL 4:** Advisory

*(Reference: SIP-008 Authority Hierarchy)*

### 3.4. Rules & Condition Context
SPL uses a context-aware condition model to ensure determinism.

```json
/*
 * EXTENSION (v1.2): Cognitive Context Namespace
 * Reserved for signals generated by SIP-015 compliant AI Agents.
 */
"axon": {
    "recommendation": "ENUM",  // Values: "ALLOW", "DENY", "ALERT"
    "confidence":     "FLOAT", // Range: 0.00 to 1.00
    "risk_category":  "STRING" // e.g., "OVERPRESSURE_PREDICTION"
}
```

*  **Trigger:** Defines *when* the policy is evaluated (e.g., TELEMETRY, INCOMING_TX).
*  **Context:** Explicitly defines the data source (e.g., LAST_TELEMETRY vs BATCH_AVG).
*  **Scope:** Policies may target individual sensors OR aggregate units (Smart Units). In unit-scoped policies, the input context includes the full telemetry map of the asset.

### 3.5. Conflict Resolution Logic (Revised)
*(Completely Revised to comply with SIP-010)*

The "Priority Integer" mechanism found in previous drafts is **DEPRECATED**. If multiple policies match a target, the Gateway/Node **MUST** resolve the conflict using the Verdict Algebra defined in SIP-010:

1.  **Authority Dominance:** Higher Authority Level (according to SIP-008) strictly overrides Lower Authority.
2.  **Deny Absorption:** If Authorities are equal, a `DENY` verdict absorbs any `ALLOW` verdict (`ALLOW Ã— DENY = DENY`).
3.  **Vacuum State:** If no valid policy matches, the result is `DENY`.

*(Reference: SIP-010 Verdict Algebra)*

### 3.6. System Defaults (Fail-Closed)
To prevent "Silent Failures," deployments **MUST** specify default behaviors in the absence of matching policies.

### 3.7. Canonical Serialization (CRITICAL)
To ensure a unique and verifiable `policy_hash` (used in SIP-003 and SIP-009), the JSON object **MUST** be serialized as follows before hashing:

* **Ordering:** Object keys MUST be sorted lexicographically (A-Z).
* **Whitespace:** No whitespace allowed outside of string values (Compact JSON).
* **Encoding:** UTF-8. No Byte Order Mark (BOM).
* **Floats:** Must be represented without exponents if possible.

> **Note:** This serialization is the foundation of the "Cryptographic Binding" used in SIP-009 Envelopes.

## 4. Rationale
The decision to avoid Turing-complete scripting ensures that policy evaluation is bounded (O(N)) and predictable. By offloading conflict resolution to the Runtime Algebra (SIP-010) and Authority to the Registry (SIP-008), SPL remains a pure, stateless definition of intent.

**Probabilistic Logic in a Deterministic System:** With the introduction of the axon namespace (SIP-015), the language accepts probabilistic inputs (floats). However, to maintain the determinism required by Section 3.7, the policy logic MUST resolve these probabilities into binary decisions using explicit threshold operators (e.g., GT 0.95). "Maybe" is not a valid output state; the Policy collapses the probability wave into a deterministic boolean at the moment of evaluation.

## 5. Copyright
Copyright and related rights waived via MIT.